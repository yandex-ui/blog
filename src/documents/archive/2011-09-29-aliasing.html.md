---
title: "Немного про сглаживание"
author: Роман Комаров
tags: [CSS, вёрстка, мобильные технологии]
---

![Варианты сглаживания текста][5]

У браузеров на основе движка webkit можно управлять сглаживанием текста через свойство `-webkit-font-smoothing`. У этого свойства бывает три возможных значения: `subpixel-antialiased`, субпиксельное сглаживание, `antialiased`, простое сглаживание, и none, совсем отключающее сглаживание.

Для десктопных систем по умолчанию применяется субпиксельное сглаживание. Напротив, в мобильных платформах, например в iOS, используется обычное сглаживание, а субпиксельное нельзя включить, даже явно его задав.

В большинстве случаев вам не придётся изменять значение этого свойства, однако существует несколько случаев, когда это может быть необходимо. Кроме того, бывают случаи, когда надо исправлять сглаживание не для текста, а для блоков, к которым применяются какие-либо CSS-трансформации. Обо всём этом мы и расскажем в этой статье.

## Потеря сглаживания из-за аппаратного ускорения или внешних объектов[<sup>пример</sup>][2]

В webkit существует одна особенность (или баг), из-за которого могут возникать ситуации, когда текст на десктопе теряет субпиксельное сглаживание. Чаще всего это может произойти по одной из следующих причин:

* Рядом или внутри блока находится флэш-объект, `iframe` или какой-то иной внешний объект.
* Рядом или внутри блока может находиться блок с применённым к нему аппаратным ускорением (например, через упомянутый в [прошлом посте][1] `-webkit-transform: translateZ(0)`).

В таких случаях можно будет заметить (особенно хорошо это может быть видно, если такой объект появляется динамически), что у текста «потерялось» субпиксельное сглаживание.

Скорее всего, это происходит из-за природы такого сглаживания. Для его рендеринга необходимо знать фон под текстом; когда же мы добавляем флеш или насильно включаем аппаратное ускорение, то и текст переносится в слой с ним. Если фон там не задан явно, то браузер не может его взять и меняет тип сглаживания. Таким образом, одним из решений будет найти блок, в котором применяется аппаратное ускорение, и задать ему или его детям явный фон. Однако в более новых версиях движка webkit этого может быть недостаточно: там сглаживание не просто не отрабатывает, а явно сбрасывается на значение `antialiased`, то есть необходимо его восстановить вручную.

Итак, для исправления потерянного сглаживания в большинстве случаев достаточно будет применить следующий код, заменив цвет фона на тот, что нужен:

    .block {
        background: #FFF;
        -webkit-font-smoothing: subpixel-antialiased;
        }

Посмотреть на потерянное сглаживание и его исправление можно на [этой тестовой странице][2].

## Отключение субпиксельного сглаживания для улучшения отображения[<sup>пример</sup>][3]

### Тёмный фон, светлый текст

![Светлый текст на тёмном фоне и серый текст на цветном фоне][9]

Достаточно известный момент, но его стоит упомянуть в этой статье: субпиксельное сглаживание устроено так, что светлые буквы на тёмном фоне будут выглядеть «жирнее», чем наоборот. Иногда подобное отображение может быть некрасивым, в таком случае для браузеров на движке webkit это можно легко исправить применив к нужному блоку `-webkit-font-smoothing: antialiased`, обычное сглаживание сделает текст тоньше.

### Менее яркий текст

Часто может возникнуть необходимость в «сером» тексте: менее ярком и не бросающемся в глаза. Обычно его делают просто: задают явно серый цвет, например `#808080`. Однако в некоторых случаях это не идеальный вариант: скажем, на цветном фоне серый текст будет выглядеть не очень хорошо (а серый на сером — и вовсе неразличим). Иногда можно встретить решение этой задачи через задание `opacity: 0.5` для блока с текстом, но при изменении `opacity` большинство браузеров не учитывает субпиксельное сглаживание, и текст может выглядеть плохо. В таком случае лучше задать цвет через `rgba:` `color: rgba(0,0,0,0.5)` — для цветов, заданных в таком виде, субпиксельное сглаживание срабатывает нормально.

Если же вам в любом случае надо применять `opacity` к блоку, то иногда будет лучше поменять сглаживание на `antialisased`, чтобы избежать проблем с субпиксельным сглаживанием.
Посмотрите на [пример с различными вариантами вёрстки неяркого текста][3].

## Сглаживание блоков, подверженных трансформациям[<sup>пример</sup>][4]

![«Лесенка» при повороте блока][8]

Кроме сглаживания текста, в современной вёрстке может встретиться и сглаживание краёв блоков или изображений. Есть несколько ситуаций, когда такое сглаживание не будет идеальным.

Например, если применять всё в том же webkit различные трансформации к какому-либо блоку или изображению (например, вращение), то края у такого блока могут оказаться не сглаженными, а «лесенкой».

Для десктопного webkit это исправляется включением аппаратного ускорения для блока добавлением `translateZ(0)` в свойство трансформации. Не забудьте, что его надо добавлять только в свойство с префиксом `-webkit-`, так как трёхмерные трансформации не поддерживаются столь широко.

Для вращения блока код в итоге будет такой:

    .rotate {
        -webkit-transform: rotate(42deg) translateZ(0);
           -moz-transform: rotate(42deg);
             -o-transform: rotate(42deg);
                transform: rotate(42deg);
        }

Однако для мобильных версий webkit этого будет недостаточно: «лесенка» всё равно будет появляться. Поправить это можно «хаком»: добавить блоку прозрачную тень с радиусом в два пикселя (одного не всегда может быть достаточно): `-webkit-box-shadow: 0 0 2px rgba(0,0,0,0)` — подобным образом мы распространяем рендеринг блока на пару лишних пикселей, и сглаживание волшебным образом появляется.

## Сглаживание текста при трансформации

![Плохое сглаживание повёрнутого текста в webkit][6]

Хотя простые CSS-трансфомации поддерживаются современными браузерами достаточно хорошо, всё ещё остаётся несколько нюансов, с которыми надо считаться.

В Опере после применения трансформаций «слетает» сглаживание шрифтов, это лучше всего можно заметить, если сначала повернуть блок на 90 градусов, а потом внутренний блок развернуть обратно:

![Пример плохого сглаживания текста в Опере][7]

А в браузерах на движке webkit при повороте блоков с субпиксельным сглаживанием будут повёрнуты и цветные пиксели, в итоге получится «размыленный» блок, который будет плохо читаться. Так что и в этом случае лучше вручную сбросить сглаживание на обычное через `-webkit-font-smoothing: antialiased`. А вот Firefox в данном случае работает отлично: он оставляет субпиксельное сглаживание и рисует цветные пиксели где нужно.

[1]: ../zoom/
[2]: http://yandex-ui.github.com/Examples/aliasing/
[3]: http://yandex-ui.github.com/Examples/aliasing/no-subpixels/
[4]: http://yandex-ui.github.com/Examples/aliasing/rotate/
[5]: http://img-fotki.yandex.ru/get/4412/1076905.1/0_67bc8_94214aef_orig
[6]: http://img-fotki.yandex.ru/get/4708/1076905.1/0_67bcb_9c3ad79f_orig
[7]: http://img-fotki.yandex.ru/get/5411/1076905.1/0_67bc6_88eabc29_orig
[8]: http://img-fotki.yandex.ru/get/4708/1076905.1/0_67bc7_9f0380ef_orig
[9]: http://img-fotki.yandex.ru/get/4612/1076905.1/0_67bca_b6091016_orig