---
title: imgo — инструмент для работы с графикой
author: Александр Титула-Бойченко
tags: [изображения, инструменты, оптимизация]
---

Рано или поздно любой веб-разработчик задается вопросом оптимизации изображений. Для этого существует множество утилит различной сложности — с графическим интерфейсом и командлайновых, общего назначения и нацеленных на один или несколько типов оптимизации.

Выбор утилиты для оптимизации пакета с графикой сайта — то еще удовольствие. Тонкая настройка каждой, замер результатов, опять настройка – все это отнимает массу времени.

Мы попробовали автоматизировать этот процесс и написали утилиту пакетной оптимизации графики, которая бы за нас решала, в какой последовательности и с какими настройками запускать другие оптимизаторы изображений. По аналогии с известным оптимизатором [csso](../csso/) этот скрипт мы назвали [imgo](http://github.com/imgo/imgo).

Цель imgo – автоматическое сжатие картинок без потери их качества. Его можно запустить в директории с картинками, и он оптимизирует все изображения до минимально возможного размера.

В ходе написания инструмента и изучения разнообразных методик сжатия изображений, стало понятно, что можно добиться существенных успехов, используя и «ручную» настройку, поэтому imgo не является исключительно автоматическим средством сжатия картинок. Он предоставляет ряд возможностей, позволяющих добиться успешного результата в сжатии картинок, и автоматизирует анализ изображений на предмет применения разных методик сжатия.

## Использование

`imgo .` Если запускать imgo с параметром точка (`.`), то будут обрабатываться все картинки (png, gif и jpg файлы), лежащие в текущей директории и ее поддиректориях.

В качестве аргумента можно передать имя одного или нескольких файлов и/или папок, которые требуется сжать:

* `imgo file.png`
* `imgo file.png file.jpg file.gif`
* `imgo file.png folder folder-2`

## Об уровнях сжатия

Уровни сжатия imgo можно условно разделить на 3 степени (это справедливо для формата PNG)

* `imgo file.png` — базовый уровень сжатия (используется по умолчанию), работает относительно быстро, применяет «безопасные» преобразования. Рекомендуется использовать на файлах, которые будут открываться c помощью IE6.

* `imgo -b file.png` — продвинутый уровень сжатия (вызывается параметром `-b` или `--brute`), применяется весь набор преобразований. Опасен тем, что некоторые файлы (с прозрачностью) могут некорректно отображаться в IE6.

* `imgo -m -b file.png` — максимальный уровень сжатия, достигается за счет многократного сжатия файла (вызывается параметром -m или -multipass). Замечено, что при дополнительном проходе можно сжать файл сильнее, но обычно счет идет на байты и доли процента.

## Возможности оптимизатора

Помимо основной задачи — сжатия изображений — imgo предоставляет ряд инструментов, помогающих в более тонкой работе с PNG.

### Установка bkgd чанка

Использование bKGD чанка — это одна из техник graceful degradation, позволяющая отказаться от pngfix в IE6. Проблема заключается в том, что IE6 некорректно обрабатывает изображения в формате PNG24 с Alpha-прозрачностью.

Например, полупрозрачный логотип HTML5:

![Полупрозрачный логотип HTML5](http://img-fotki.yandex.ru/get/6101/1861097.22/0_79fd9_13413784_orig)

в IE6 будет выглядеть как:

![Полупрозрачный логотип HTML5 в IE6](http://img-fotki.yandex.ru/get/6101/1861097.22/0_79dff_15ed20fb_orig)

Чаще всего, подобное поведение исправляется с помощью фильтра AlphaImageLoader, однако это не единственный способ добиться приемлемого результата. Если изображению задать цвет bKGD чанка, то IE6 будет показывать картинку так, как будто она находится поверх слоя с этим цветом.

`imgo -bkgdwhite file.png` Логотип на белом фоне:

![Логотип на белом фоне](http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e00_9028cea8_orig)

`imgo -bkgd#ffc927 file.png` Логотип на оранжевом фоне:

![Логотип на оранжевом фоне](http://img-fotki.yandex.ru/get/6201/1861097.22/0_79e01_a0d043af_orig)

Обратите внимание на то, что мы не теряем прозрачность, а просто меняем серый цвет, который «рисует» IE6 на произвольный. Если к такому изображения применить AlphaImageLoader, оно станет полупрозрачным. Остальные браузеры игнорируют bKGD чанк и продолжают показывать изображение с полупрозрачностью.

### Чистка прозрачных областей

В процессе оптимизации все PNG24, имеющие прозрачность, подвергаются чистке прозрачных областей.

Если не вдаваться в технические детали, то файл png24 с прозрачностью можно разделить на два слоя. Первый — это само изображение, второй — это маска прозрачности.

Тестовое изображение (19.6 Кб):

![Тестовое изображение](http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e02_dae7fe87_-1-orig)

Если его разбить на две части, то получим такую картину:

Само изображение (14.6 Кб):

![Само изображение](http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e03_ef2d41a7_orig)

Альфа-канал (маска, 1.16 Кб):

![Альфа канал](http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e04_4c1907ac_orig)

Очевидно, что в оригинальном изображении находится лишняя информация, которая негативно влияет на размер изображения. imgo такую информацию заливает черным цветом.

Если пропустить оригинальную картинку через imgo и снова разложить ее на два слоя, то в результате для самого изображения мы получим (3.27 Кб):

![Чистка прозрачных областей](http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e05_7e9f41bb_-1-orig)

Подобная техника не влияет на видимую часть картинки, поэтому такое преобразование является безопасным, то есть преобразованием без потерь.

Иногда появляется необходимость посмотреть на «оригинальное» изображение без прозрачности. Для этих целей есть аргумент `-rt`

`imgo -rt file.png`

В результате выполнения этой команды появится файл file_imgo_rt.png, предоставляющий из себя оригинальный файл png, в котором была удалена маска прозрачности.

### Конвертация в PNG8 c Alpha прозрачностью

Прозрачность в PNG8 можно разделить на 2 типа.

1. Бинарная прозрачность (пиксель или полностью прозрачный или полностью непрозрачный). Аналогичная прозрачность нам известна по формату файлов GIF. Как правило, именно такая прозрачность и используется в большинстве случаев.

2. Alpha-канал, прозрачность каждого пикселя можно менять от 0 до 255, с шагом в 1.

Позволяет конвертировать png24 c Alpha-каналом в png8 c Alpha-каналом. Следует помнить, что png8 ограничен 256 цветами, поэтому, если исходное изображение имеет много цветов, то imgo их упростит до 256.

Логотип HTML5: PNG24 + Alpha-прозрачность (7,1 Кб)

![PNG24 + Alpha прозрачность](http://img-fotki.yandex.ru/get/6201/1861097.22/0_79fda_e54f08b0_orig)

Логотип HTML5: PNG8 + Alpha-прозрачность (3.2 Кб)

![PNG8 + Alpha прозрачность](http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e07_75eee8fc_orig)

Помимо уменьшения размера изображения, использование подобных изображений — одна из методик graceful degradation. Дело в том, что IE6 подобные изображения показывает некорректно — он делает абсолютно прозрачными все полупрозрачные области.

`imgo -png8a file.png` После этой команды рядом с файлом file.png появится файл file_png8a.png, который вы сможете сравнить и, если уровень потерь будет приемлемый, заменить им оригинальный файл.

### Разложение PNG24+Alpha на два файла

Один из способов уменьшения размера подобных изображений — это разбитие его на два.

Допустим, у нас есть картинка (7.1 Кб):

![Тестовое изображение](http://img-fotki.yandex.ru/get/5606/1861097.22/0_79fdb_10d825bc_orig)

Выполнив команду `imgo -s file.png` мы получим следующие два файла:

Первый будет содержать в себе все непрозрачные пиксели (1.61 Кб):

![Все непрозрачные пиксели](http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e09_d99329a3_orig)

Второй будет содержать в себе всю полупрозрачность (1.28 Кб):

![Вся полупрозрачность](http://img-fotki.yandex.ru/get/6201/1861097.22/0_79e0a_fe97ab56_orig)

Наложением этих двух картинок друг на друга получим оригинальное изображение.

После выполнения команды imgo -s file.png рядом с файлом file.png создастся 3 новых:

* `file_imgo_alpha.png` — PNG24, слой, содержащий в себе только полупрозрачные пиксели изображения;
* `file_imgo_crop.png` — PNG24, слой, содержащий в себе все непрозрачные пиксели изображения;
* `file_imgo_crop-nq8.png` — PNG8, полученный из `file_imgo_crop.png`, с потерей качества.

Как правило, выигрыш получается наложением слоя с полупрозрачностью и PNG8, слой с PNG24 создается для того, чтобы мы могли визуально сравнить разницу между PNG24 и PNG8 файлами. Если она незаметна или допустима, методику можно применять к данному изображению.

## Где брать и как устанавливать?

Адрес репозитория: http://github.com/imgo/imgo

Инструкция по установке (macOS): https://github.com/imgo/imgo#readme

Место, где можно оставлять пожелания и сообщения об ошибках: https://github.com/imgo/imgo/issues 

Мы следим за появлением новых утилит и техник сжатия изображений и стараемся оперативно обновлять imgo. 

Подписывайтесь на комиты в github, чтобы быть в курсе обновлений imgo.
