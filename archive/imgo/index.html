<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7,IE=edge"><meta name="viewport" content="width=device-width"><meta name="generator" content="DocPad v6.65.0" /><link  rel="stylesheet" href="/blog/style.css" /></head><body><div class="page"><h1 class="page-head">Архив клуба разработки интерфейсов</h1><div class="page-content"><header><h1>imgo — инструмент для работы с графикой</h1><p>Опубликовано Thu Jul 24 2014 15:10:47 GMT+0400 (MSK). Автор: Александр Титула-Бойченко.</p></header><p>Рано или поздно любой веб-разработчик задается вопросом оптимизации изображений. Для этого существует множество утилит различной сложности — с графическим интерфейсом и командлайновых, общего назначения и нацеленных на один или несколько типов оптимизации.</p>
<p>Выбор утилиты для оптимизации пакета с графикой сайта — то еще удовольствие. Тонкая настройка каждой, замер результатов, опять настройка – все это отнимает массу времени.</p>
<p>Мы попробовали автоматизировать этот процесс и написали утилиту пакетной оптимизации графики, которая бы за нас решала, в какой последовательности и с какими настройками запускать другие оптимизаторы изображений. По аналогии с известным оптимизатором <a href="../csso/">csso</a> этот скрипт мы назвали <a href="http://github.com/imgo/imgo">imgo</a>.</p>
<p>Цель imgo – автоматическое сжатие картинок без потери их качества. Его можно запустить в директории с картинками, и он оптимизирует все изображения до минимально возможного размера.</p>
<p>В ходе написания инструмента и изучения разнообразных методик сжатия изображений, стало понятно, что можно добиться существенных успехов, используя и «ручную» настройку, поэтому imgo не является исключительно автоматическим средством сжатия картинок. Он предоставляет ряд возможностей, позволяющих добиться успешного результата в сжатии картинок, и автоматизирует анализ изображений на предмет применения разных методик сжатия.</p>
<h2 id="-">Использование</h2>
<p><code>imgo .</code> Если запускать imgo с параметром точка (<code>.</code>), то будут обрабатываться все картинки (png, gif и jpg файлы), лежащие в текущей директории и ее поддиректориях.</p>
<p>В качестве аргумента можно передать имя одного или нескольких файлов и/или папок, которые требуется сжать:</p>
<ul>
<li><code>imgo file.png</code></li>
<li><code>imgo file.png file.jpg file.gif</code></li>
<li><code>imgo file.png folder folder-2</code></li>
</ul>
<h2 id="-">Об уровнях сжатия</h2>
<p>Уровни сжатия imgo можно условно разделить на 3 степени (это справедливо для формата PNG)</p>
<ul>
<li><p><code>imgo file.png</code> — базовый уровень сжатия (используется по умолчанию), работает относительно быстро, применяет «безопасные» преобразования. Рекомендуется использовать на файлах, которые будут открываться c помощью IE6.</p>
</li>
<li><p><code>imgo -b file.png</code> — продвинутый уровень сжатия (вызывается параметром <code>-b</code> или <code>--brute</code>), применяется весь набор преобразований. Опасен тем, что некоторые файлы (с прозрачностью) могут некорректно отображаться в IE6.</p>
</li>
<li><p><code>imgo -m -b file.png</code> — максимальный уровень сжатия, достигается за счет многократного сжатия файла (вызывается параметром -m или -multipass). Замечено, что при дополнительном проходе можно сжать файл сильнее, но обычно счет идет на байты и доли процента.</p>
</li>
</ul>
<h2 id="-">Возможности оптимизатора</h2>
<p>Помимо основной задачи — сжатия изображений — imgo предоставляет ряд инструментов, помогающих в более тонкой работе с PNG.</p>
<h3 id="-bkgd-">Установка bkgd чанка</h3>
<p>Использование bKGD чанка — это одна из техник graceful degradation, позволяющая отказаться от pngfix в IE6. Проблема заключается в том, что IE6 некорректно обрабатывает изображения в формате PNG24 с Alpha-прозрачностью.</p>
<p>Например, полупрозрачный логотип HTML5:</p>
<p><img src="http://img-fotki.yandex.ru/get/6101/1861097.22/0_79fd9_13413784_orig" alt="Полупрозрачный логотип HTML5"></p>
<p>в IE6 будет выглядеть как:</p>
<p><img src="http://img-fotki.yandex.ru/get/6101/1861097.22/0_79dff_15ed20fb_orig" alt="Полупрозрачный логотип HTML5 в IE6"></p>
<p>Чаще всего, подобное поведение исправляется с помощью фильтра AlphaImageLoader, однако это не единственный способ добиться приемлемого результата. Если изображению задать цвет bKGD чанка, то IE6 будет показывать картинку так, как будто она находится поверх слоя с этим цветом.</p>
<p><code>imgo -bkgdwhite file.png</code> Логотип на белом фоне:</p>
<p><img src="http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e00_9028cea8_orig" alt="Логотип на белом фоне"></p>
<p><code>imgo -bkgd#ffc927 file.png</code> Логотип на оранжевом фоне:</p>
<p><img src="http://img-fotki.yandex.ru/get/6201/1861097.22/0_79e01_a0d043af_orig" alt="Логотип на оранжевом фоне"></p>
<p>Обратите внимание на то, что мы не теряем прозрачность, а просто меняем серый цвет, который «рисует» IE6 на произвольный. Если к такому изображения применить AlphaImageLoader, оно станет полупрозрачным. Остальные браузеры игнорируют bKGD чанк и продолжают показывать изображение с полупрозрачностью.</p>
<h3 id="-">Чистка прозрачных областей</h3>
<p>В процессе оптимизации все PNG24, имеющие прозрачность, подвергаются чистке прозрачных областей.</p>
<p>Если не вдаваться в технические детали, то файл png24 с прозрачностью можно разделить на два слоя. Первый — это само изображение, второй — это маска прозрачности.</p>
<p>Тестовое изображение (19.6 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e02_dae7fe87_-1-orig" alt="Тестовое изображение"></p>
<p>Если его разбить на две части, то получим такую картину:</p>
<p>Само изображение (14.6 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e03_ef2d41a7_orig" alt="Само изображение"></p>
<p>Альфа-канал (маска, 1.16 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e04_4c1907ac_orig" alt="Альфа канал"></p>
<p>Очевидно, что в оригинальном изображении находится лишняя информация, которая негативно влияет на размер изображения. imgo такую информацию заливает черным цветом.</p>
<p>Если пропустить оригинальную картинку через imgo и снова разложить ее на два слоя, то в результате для самого изображения мы получим (3.27 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e05_7e9f41bb_-1-orig" alt="Чистка прозрачных областей"></p>
<p>Подобная техника не влияет на видимую часть картинки, поэтому такое преобразование является безопасным, то есть преобразованием без потерь.</p>
<p>Иногда появляется необходимость посмотреть на «оригинальное» изображение без прозрачности. Для этих целей есть аргумент <code>-rt</code></p>
<p><code>imgo -rt file.png</code></p>
<p>В результате выполнения этой команды появится файл file_imgo_rt.png, предоставляющий из себя оригинальный файл png, в котором была удалена маска прозрачности.</p>
<h3 id="-png8-c-alpha-">Конвертация в PNG8 c Alpha прозрачностью</h3>
<p>Прозрачность в PNG8 можно разделить на 2 типа.</p>
<ol>
<li><p>Бинарная прозрачность (пиксель или полностью прозрачный или полностью непрозрачный). Аналогичная прозрачность нам известна по формату файлов GIF. Как правило, именно такая прозрачность и используется в большинстве случаев.</p>
</li>
<li><p>Alpha-канал, прозрачность каждого пикселя можно менять от 0 до 255, с шагом в 1.</p>
</li>
</ol>
<p>Позволяет конвертировать png24 c Alpha-каналом в png8 c Alpha-каналом. Следует помнить, что png8 ограничен 256 цветами, поэтому, если исходное изображение имеет много цветов, то imgo их упростит до 256.</p>
<p>Логотип HTML5: PNG24 + Alpha-прозрачность (7,1 Кб)</p>
<p><img src="http://img-fotki.yandex.ru/get/6201/1861097.22/0_79fda_e54f08b0_orig" alt="PNG24 + Alpha прозрачность"></p>
<p>Логотип HTML5: PNG8 + Alpha-прозрачность (3.2 Кб)</p>
<p><img src="http://img-fotki.yandex.ru/get/6200/1861097.22/0_79e07_75eee8fc_orig" alt="PNG8 + Alpha прозрачность"></p>
<p>Помимо уменьшения размера изображения, использование подобных изображений — одна из методик graceful degradation. Дело в том, что IE6 подобные изображения показывает некорректно — он делает абсолютно прозрачными все полупрозрачные области.</p>
<p><code>imgo -png8a file.png</code> После этой команды рядом с файлом file.png появится файл file_png8a.png, который вы сможете сравнить и, если уровень потерь будет приемлемый, заменить им оригинальный файл.</p>
<h3 id="-png24-alpha-">Разложение PNG24+Alpha на два файла</h3>
<p>Один из способов уменьшения размера подобных изображений — это разбитие его на два.</p>
<p>Допустим, у нас есть картинка (7.1 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/5606/1861097.22/0_79fdb_10d825bc_orig" alt="Тестовое изображение"></p>
<p>Выполнив команду <code>imgo -s file.png</code> мы получим следующие два файла:</p>
<p>Первый будет содержать в себе все непрозрачные пиксели (1.61 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6101/1861097.22/0_79e09_d99329a3_orig" alt="Все непрозрачные пиксели"></p>
<p>Второй будет содержать в себе всю полупрозрачность (1.28 Кб):</p>
<p><img src="http://img-fotki.yandex.ru/get/6201/1861097.22/0_79e0a_fe97ab56_orig" alt="Вся полупрозрачность"></p>
<p>Наложением этих двух картинок друг на друга получим оригинальное изображение.</p>
<p>После выполнения команды imgo -s file.png рядом с файлом file.png создастся 3 новых:</p>
<ul>
<li><code>file_imgo_alpha.png</code> — PNG24, слой, содержащий в себе только полупрозрачные пиксели изображения;</li>
<li><code>file_imgo_crop.png</code> — PNG24, слой, содержащий в себе все непрозрачные пиксели изображения;</li>
<li><code>file_imgo_crop-nq8.png</code> — PNG8, полученный из <code>file_imgo_crop.png</code>, с потерей качества.</li>
</ul>
<p>Как правило, выигрыш получается наложением слоя с полупрозрачностью и PNG8, слой с PNG24 создается для того, чтобы мы могли визуально сравнить разницу между PNG24 и PNG8 файлами. Если она незаметна или допустима, методику можно применять к данному изображению.</p>
<h2 id="-">Где брать и как устанавливать?</h2>
<p>Адрес репозитория: <a href="http://github.com/imgo/imgo">http://github.com/imgo/imgo</a></p>
<p>Инструкция по установке (macOS): <a href="https://github.com/imgo/imgo#readme">https://github.com/imgo/imgo#readme</a></p>
<p>Место, где можно оставлять пожелания и сообщения об ошибках: <a href="https://github.com/imgo/imgo/issues">https://github.com/imgo/imgo/issues</a> </p>
<p>Мы следим за появлением новых утилит и техник сжатия изображений и стараемся оперативно обновлять imgo. </p>
<p>Подписывайтесь на комиты в github, чтобы быть в курсе обновлений imgo.</p>
</div></div><!-- Yandex.Metrika counter --><div style="display:none;"><script type="text/javascript">(function(w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter8530063 = new Ya.Metrika({id:8530063, enableAll: true}); } catch(e) { } }); })(window, "yandex_metrika_callbacks");</script></div><script src="//mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script><noscript><div><img src="//mc.yandex.ru/watch/8530063" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter --></body></html>